<!DOCTYPE html>
<html>
<head>
    <title>Test Backend</title>
    <meta charset="utf-8" />
    <style>
        .voice-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        .voice-btn:hover {
            background-color: #45a049;
        }
        .voice-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .listening {
            background-color: #ff4444 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <h1>Test Our Backend</h1>

    <div>
        <strong>Current personality:</strong>
        <span id="current-personality">loading‚Ä¶</span>
    </div>

    <div style="margin-top:10px;">
        <button id="btn-health">Test Health</button>
        <button id="btn-test-chat">Test Chat</button>
    </div>

    <div style="margin-top:10px;">
        <label for="personality-select">Choose personality:</label>
        <select id="personality-select"></select>
        <button id="btn-switch">Switch</button>
    </div>

    <!-- Persona preview added -->
    <div id="persona-preview" style="margin-top:10px; padding:8px; border:1px solid #ddd; background:#fafafa;">
        <strong id="persona-name">...</strong>
        <div id="persona-desc" style="margin-top:6px; color:#333;"></div>
        <pre id="persona-format" style="margin-top:8px; white-space:pre-wrap; color:#444; font-size:13px;"></pre>
    </div>

    <div style="margin-top:12px;">
        <label for="education-select">Your education level:</label>
        <select id="education-select" style="margin-left:8px;">
            <option value="">(not set)</option>
            <option value="elementary">Elementary</option>
            <option value="middle_school">Middle school</option>
            <option value="high_school">High school</option>
            <option value="undergraduate">Undergraduate</option>
            <option value="graduate">Graduate / Postgrad</option>
            <option value="professional">Professional / Instructor</option>
        </select>

        <label for="grade" style="margin-left:16px;">Grade / Year (optional):</label>
        <input id="grade" style="width:80px; margin-left:8px;" placeholder="e.g. 10" />
    </div>

    <div style="margin-top:12px;">
        <label for="topic">Subject / Topic:</label><br>
        <input id="topic" style="width:90%;" placeholder="e.g. photosynthesis, algebra, intro to Python" />
    </div>

    <div style="margin-top:20px;">
        <label for="message">Message / Instruction:</label><br>
        <input id="message" style="width:80%;" placeholder="e.g. explain photosynthesis" />
        <button id="btn-send">Send</button>
        <button id="btn-voice" class="voice-btn">üé§ Voice Input</button>
    </div>

    <div id="voice-status" style="margin-top:10px; color:#666; font-style:italic;"></div>

    <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap;"></div>
    <button id="btn-play-audio" style="margin-top:10px; display:none;">Play AI Voice</button>
    <audio id="ai-audio" style="display:none;" controls></audio>

    <script>
        const API_BASE = 'http://localhost:5000';
        let currentPersonality = null;
        const sel = document.getElementById('personality-select');
        const curSpan = document.getElementById('current-personality');
        const result = document.getElementById('result');
        const educationEl = document.getElementById('education-select');
        const topicEl = document.getElementById('topic');
        const gradeEl = document.getElementById('grade');
        const messageEl = document.getElementById('message');
        const voiceBtn = document.getElementById('btn-voice');
        const voiceStatus = document.getElementById('voice-status');

        async function loadPersonalities() {
            try {
                const res = await fetch(`${API_BASE}/api/personalities`);
                const data = await res.json();
                const list = data.available_personalities || [];

                sel.innerHTML = '';
                list.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.key;
                    opt.textContent = `${p.name || p.key} ‚Äî ${p.key}`;
                    sel.appendChild(opt);
                });

                currentPersonality = data.active_personality || (list[0] && list[0].key) || '';
                curSpan.textContent = currentPersonality;
                if (currentPersonality) sel.value = currentPersonality;
            } catch (err) {
                curSpan.textContent = 'error';
                result.textContent = 'Failed to load personalities: ' + String(err);
            }
        }

        async function testHealth() {
            try {
                const r = await fetch(`${API_BASE}/health`);
                const d = await r.json();
                result.textContent = JSON.stringify(d, null, 2);
            } catch (e) {
                result.textContent = String(e);
            }
        }

        async function testChat() {
            const payload = {
                message: 'Hello from test!',
                personality: currentPersonality,
                topic: topicEl.value || undefined,
                education: educationEl.value || undefined,
                grade: gradeEl.value || undefined
            };
            try {
                const r = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const d = await r.json();
                result.textContent = d.response ?? JSON.stringify(d, null, 2);
            } catch (e) {
                result.textContent = String(e);
            }
        }

        document.getElementById('btn-play-audio').onclick = function() {
            const audioEl = document.getElementById('ai-audio');
            if (audioEl.src) {
                audioEl.play();
            }
        };

        async function captureVoice() {
            voiceBtn.disabled = true;
            voiceBtn.classList.add('listening');
            voiceStatus.textContent = 'üé§ Listening... (speak now)';
            
            try {
                const r = await fetch(`${API_BASE}/api/listen`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const d = await r.json();
                
                if (d.status === 'success' && d.text) {
                    messageEl.value = d.text;
                    voiceStatus.textContent = `‚úÖ Captured: "${d.text}"`;
                    voiceStatus.style.color = '#4CAF50';
                } else {
                    voiceStatus.textContent = `‚ö†Ô∏è ${d.message || 'No speech detected'}`;
                    voiceStatus.style.color = '#ff9800';
                }
            } catch (e) {
                voiceStatus.textContent = '‚ùå Error: ' + String(e);
                voiceStatus.style.color = '#f44336';
            } finally {
                voiceBtn.disabled = false;
                voiceBtn.classList.remove('listening');
            }
        }

        async function sendMessage() {
            const message = messageEl.value || 'Hello';
            const payload = {
                message,
                personality: currentPersonality,
                topic: topicEl.value || undefined,
                education: educationEl.value || undefined,
                grade: gradeEl.value || undefined
            };
            try {
                const r = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                if (!r.ok) {
                    const text = await r.text();
                    let parsed;
                    try { parsed = JSON.parse(text); } catch { parsed = null; }
                    result.textContent = (parsed && parsed.response) ? parsed.response : text;
                    return;
                }
                const d = await r.json();
                result.textContent = d.response ?? JSON.stringify(d, null, 2);
                
                const playBtn = document.getElementById('btn-play-audio');
                const audioEl = document.getElementById('ai-audio');
                if (d.audio_b64) {
                    audioEl.src = `data:audio/mp3;base64,${d.audio_b64}`;
                    playBtn.style.display = '';
                    audioEl.style.display = '';
                } else {
                    playBtn.style.display = 'none';
                    audioEl.style.display = 'none';
                }
            } catch (e) {
                result.textContent = String(e);
            }
        }

        async function switchPersonality() {
            const chosen = sel.value;
            if (!chosen) return;
            try {
                const r = await fetch(`${API_BASE}/api/personality`, {
                    method: 'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ personality: chosen })
                });
                const d = await r.json();
                currentPersonality = d.personality || chosen;
                curSpan.textContent = currentPersonality;
                result.textContent = d.message ?? JSON.stringify(d, null, 2);
            } catch (e) {
                result.textContent = String(e);
            }
        }

        document.getElementById('btn-health').addEventListener('click', testHealth);
        document.getElementById('btn-test-chat').addEventListener('click', testChat);
        document.getElementById('btn-send').addEventListener('click', sendMessage);
        document.getElementById('btn-switch').addEventListener('click', switchPersonality);
        document.getElementById('btn-voice').addEventListener('click', captureVoice);

        loadPersonalities();
    </script>
</body>
</html>